
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Using Docker to Cross-Compile</title>
    
    <!-- Description content not available -->
    
    <link rel="alternate" type="application/atom+xml" href="/ev3dev.github.io/news/atom.xml" title="Atom feed">
    <link rel="icon" href="/ev3dev.github.io/favicon.ico" />

    <!-- Bootstrap styles -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/bootstrap.css">

    <!-- X3D styles and scripts -->
    <!-- x3dom.js is nearly 1 MB of data so we only include it if necessary  -->
    
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/site-structure.css">
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/search.css">
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/landing-content.css">
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/page-content.css">
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/user-cards.css">
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/tabs.css">

    <!-- Python code highlighting -->
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/pygments/monokai.css" />
    
    <!-- 3rd-party libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script src="/ev3dev.github.io/javascripts/bootstrap/bootstrap.min.js"></script>
    <script src="/ev3dev.github.io/javascripts/jquery.getUrlParam.js"></script>
    <script src="/ev3dev.github.io/javascripts/jquery.loadTemplate-1.4.4.min.js"></script>
    <script src="/ev3dev.github.io/javascripts/respond.js"></script>
    <script src="/ev3dev.github.io/javascripts/ua-parser.min.js"></script>
    <script src="https://npmcdn.com/imagesloaded@4.1/imagesloaded.pkgd.min.js"></script>
    

    <!-- Caches data from requests to API endpoints -->
    <script src="/ev3dev.github.io/javascripts/api-cache.js"></script>
    <!-- Loads user-cards from GH API -->
    <script src="/ev3dev.github.io/javascripts/cards.js"></script>
    <!-- Configures special anchors to link to the most recent ev3dev release -->
    <script src="/ev3dev.github.io/javascripts/releases.js"></script>
    <!-- Responds to queries typed into the "Quick nav" box -->
    <script src="/ev3dev.github.io/javascripts/search.js"></script>
    <!-- Converts static descriptors of tab target content into live text and links -->
    <script src="/ev3dev.github.io/javascripts/tabs.js"></script>
    <!-- Adds classes and other styles to pages where hard-coded css can't be used -->
    <script src="/ev3dev.github.io/javascripts/style-helpers.js"></script>

    <!-- Template for search results -->
    <script type="text/html" id="search-result-template">
        <div class="search-result">
            <a data-href="href"><h4 data-content="title"></h4></a>
            <span data-content="breadcrumbs" class="search-result-breadcrumbs"></span>
            <span data-content="author" class="search-result-author"></span><br/>
        </div>
    </script>

    

</head>


<body class="no-jumbotron ">

    <div id="header">
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/ev3dev.github.io/">
                    <img id="brand-logo" src="/ev3dev.github.io/images/ev3dev_logo_white.png" alt="ev3dev logo" />
                </a>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav" id="main-nav">
                    <li>
                        <a href="/ev3dev.github.io/" title="There's no place like Home...">Home</a>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" href="#" data-toggle="dropdown" title="Documentation on using ev3dev">
                            Docs
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="/ev3dev.github.io/docs/getting-started">Getting Started</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/docs/tutorials">Tutorials</a>
                            </li>
                            <li role="separator" class="divider"></li>
                            <li>
                                <a href="/ev3dev.github.io/docs/motors">Motors</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/docs/sensors">Sensors</a>
                            </li>
                            <li role="separator" class="divider"></li>
                            <li>
                                <a href="/ev3dev.github.io/docs">More...</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="/ev3dev.github.io/news" title="News about ev3dev">News</a>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            Community
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="/ev3dev.github.io/projects" title="Discover projects that use ev3dev">Projects</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/share" title="Share projects that use ev3dev">Share</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/contribute" title="How to contribute to ev3dev">Contribute</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/support" title="Found a bug? Have a question?">Get Help</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="https://github.com/ev3dev/ev3dev/releases" title="SD card image files">Download</a>
                    </li>
                </ul>
                <!-- items below float right, so appear in reverse order -->
                <div id="search-container">
                    <form class="navbar-form navbar-right dropdown" onsubmit="return false;">
                        <input type="text" id="search-input" class="form-control" placeholder="Quick nav" autocomplete="off" />
                        <div class="dropdown-menu" id="search-dropdown">
                            <div class="search-results-container" id="search-results-docs">
                                <h2>In docs</h2>
                                <div data-content="docs-results">
                                    <div class="no-results-note">No results</div>
                                </div>
                            </div>

                            <div class="search-results-container" id="search-results-projects">
                                <h2>In projects</h2>
                                <div data-content="project-results">
                                    <div class="no-results-note">No results</div>
                                </div>
                            </div>

                            <div class="search-results-container" id="search-results-news">
                                <h2>In news</h2>
                                <div data-content="news-results">
                                    <div class="no-results-note">No results</div>
                                </div>
                            </div>

                            <div class="search-results-container" id="search-results-misc">
                                <h2>In other pages</h2>
                                <div data-content="misc-results">
                                    <div class="no-results-note">No results</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </nav>
</div>

    
    
    <div class="container">
        

<div class="page-header">
    <h1>
        Using Docker to Cross-Compile
        <small></small>
        
            <a class="btn btn-primary pull-right" href="https://github.com/ev3dev/ev3dev.github.io/edit/master/docs/tutorials/using-docker-to-cross-compile.md">Edit on Github</a>
        
    </h1>
</div>
    </div>
    
    
    <div class="container">
    
        <hr />
<div class="nav-dropdown-arrow">
    <div>
        

<ol class="breadcrumb" vocab="http://schema.org" typeof="BreadcrumbList">
    
    
        
        
        
        <li property="itemListElement" typeof="ListItem" class="">
            <a href="/ev3dev.github.io/docs/" property="item" typeof="WebPage">
                <span property="name">docs</span>
            </a>
            <meta property="position" content="1">
        </li>
        
    
        
        
        
        <li property="itemListElement" typeof="ListItem" class="">
            <a href="/ev3dev.github.io/docs/tutorials/" property="item" typeof="WebPage">
                <span property="name">tutorials</span>
            </a>
            <meta property="position" content="2">
        </li>
        
    
        
        
        
        <li property="itemListElement" typeof="ListItem" class="active">
            <span href="/ev3dev.github.io/docs/tutorials/" property="item" typeof="WebPage">
                <span property="name">using-docker-to-cross-compile</span>
            </span>
            <meta property="position" content="3">
        </li>
        
    
</ol>
    </div>
    
</div>
<hr />

<ul id="markdown-toc">
  <li><a href="#getting-docker" id="markdown-toc-getting-docker">Getting Docker</a></li>
  <li><a href="#download-the-ev3dev-cross-compiler-image" id="markdown-toc-download-the-ev3dev-cross-compiler-image">Download the ev3dev cross-compiler image</a></li>
  <li><a href="#hello-world" id="markdown-toc-hello-world">Hello World!</a></li>
  <li><a href="#using-the-real-cross-compiler" id="markdown-toc-using-the-real-cross-compiler">Using the “Real” Cross-Compiler</a></li>
  <li><a href="#using-gdb" id="markdown-toc-using-gdb">Using GDB</a></li>
  <li><a href="#example-building-the-brickman-package" id="markdown-toc-example-building-the-brickman-package">Example: Building the brickman Package</a></li>
</ul>

<p class="lead clearfix"><a href="http://www.docker.com/">Docker</a> is a light-weight virtual machine with excellent cross-platform support.
This allows us to run something very close to the ev3dev OS on any desktop or
notebook computer. This means that we get the same versions of all of the libraries
running on the EV3 but compile with the power of a desktop processor.</p>

<p class="lead well">We are totally new to Docker, so this tutorial is a work in progress. Please
let us know if you have problems or find a better way of doing it!</p>

<p class="alert alert-warning"><span class="glyphicon glyphicon-alert" aria-hidden="true"></span>
This will only work on 64-bit operating systems. We do not maintain images for
32-bit operating systems.</p>

<h2 id="getting-docker">Getting Docker</h2>

<p class="well">Docker has excellent documentation, so we will just send you to their
<a href="http://www.docker.com/products/docker">download</a> page. Come back when you have
Docker installed for Windows, Mac or Linux.</p>

<div class="panel panel-info">
  <p class="panel-heading"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
Linux</p>

  <div class="panel-body">
    <p>Docker for Linux has quite a bit of information to read. This may help you sort
through it. The most important parts are:</p>

    <ul>
      <li>Add the Docker package repository</li>
      <li>Install the <code class="highlighter-rouge">docker-engine</code> package</li>
      <li>Add your user to the <code class="highlighter-rouge">docker</code> group</li>
    </ul>
  </div>
</div>

<h2 id="download-the-ev3dev-cross-compiler-image">Download the ev3dev cross-compiler image</h2>

<p>We provide images with developer tools already installed. Grab the one appropriate
for your hardware…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker pull ev3dev/debian-jessie-armel-cross
</code></pre>
</div>

<p>This will take some time. The download is hundreds of megabytes.</p>

<p>When it is finished, we can give it a shorter name…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker tag ev3dev/debian-jessie-armel-cross ev3cc
</code></pre>
</div>

<p class="alert alert-info"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
Docker images are immutable. You can always revert back to this image after making
changes without having to download it again.</p>

<p>You can see a list of images you have downloaded by running…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker images
</code></pre>
</div>

<p>… and delete them with…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker rmi &lt;image-name-or-hash&gt;
</code></pre>
</div>

<h2 id="hello-world">Hello World!</h2>

<p>Let’s do the classic hello world program in C. Create a new, empty directory
wherever you like. In your favorite text editor, paste this and save it as
<code class="highlighter-rouge">hello.c</code>. For this example, we will be using <code class="highlighter-rouge">C:\Users\myname\example\hello.c</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#include &lt;stdio.h&gt;

int main(int argc, const char *argv[])
{
    printf("Hello World!\n");

    return 0;
}
</code></pre>
</div>

<p class="alert alert-warning"><span class="glyphicon glyphicon-alert" aria-hidden="true"></span>
If you are using Windows, you must explicitly allow <a href="https://docs.docker.com/docker-for-windows/#/shared-drives" class="alert-link">shared drives in the Docker
control panel first</a>!</p>

<p>Now, we compile using the docker image. First we run a new docker container…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker run --rm -it -v C:\Users\myname\example\:/home/compiler/example ev3cc
</code></pre>
</div>

<p>Let’s break down the command:</p>

<ul>
  <li><code class="highlighter-rouge">run</code> means we are running a new container.</li>
  <li><code class="highlighter-rouge">--rm</code> indicates that we want to throw away the container when we are done.
If you don’t do this, docker saves a new container from each <code class="highlighter-rouge">run</code> command,
which takes up space on your hard drive.</li>
  <li><code class="highlighter-rouge">-it</code> is two options, it means “interactive” and “tty”. This will let us use
the command prompt inside of the container.</li>
  <li><code class="highlighter-rouge">-v &lt;host-path&gt;:&lt;container-path&gt;</code> lets us use a directory from our host computer
inside of the container.</li>
  <li><code class="highlighter-rouge">ev3cc</code> is the name of the docker image we are using.</li>
</ul>

<p>In the docker container, we are logged in as a user named <code class="highlighter-rouge">compiler</code> and start
in the <code class="highlighter-rouge">/home/compiler</code> directory (<code class="highlighter-rouge">~</code> for short). First we need to go to our
<code class="highlighter-rouge">example</code> directory…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd example
</code></pre>
</div>

<p>And we can compile our program…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>gcc hello.c -o hello
</code></pre>
</div>

<p>Since this program does not depend on any hardware drivers, we can actually run
this program inside of the docker container!</p>

<div class="highlighter-rouge"><pre class="highlight"><code>./hello
</code></pre>
</div>

<p>This will output:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Hello World!
</code></pre>
</div>

<p>Also, a binary file called <code class="highlighter-rouge">hello</code> will now exist in <code class="highlighter-rouge">C:\Users\myname\example</code>
on your host computer. You can copy this file to your EV3 and run it!</p>

<p>To exit the docker container, simply type…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>exit
</code></pre>
</div>

<h2 id="using-the-real-cross-compiler">Using the “Real” Cross-Compiler</h2>

<p>In the hello world example above, we used the <code class="highlighter-rouge">gcc</code> command to compile our program.
This is actually an ARM executable file that is being run using QEMU to emulate
the ARM architecture. We didn’t notice because our example was so small, but this
can be very slow for large programs.</p>

<p>However, our image has a “real” cross-compiler. This is a version of <code class="highlighter-rouge">gcc</code> that
runs natively on x86_64 hardware but produces binaries that run on ARM hardware.
To use this version of <code class="highlighter-rouge">gcc</code> instead, there are a couple things we need to do.</p>

<p>First, let’s make a variable to save some typing because the cross-compiler has
a very long path name.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>export CC=/opt/gcc-linaro-5.3-2016.02-x86_64_arm-linux-gnueabi/bin/arm-linux-gnueabi-gcc
</code></pre>
</div>

<p>Now we can compile using the cross-compiler. It is important to add the <code class="highlighter-rouge">--sysroot</code>
option because by default the cross-compiler looks in its own system root directory
instead.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$CC --sysroot=/ hello.c -o hello
</code></pre>
</div>

<h2 id="using-gdb">Using GDB</h2>

<p><code class="highlighter-rouge">gdb</code> is the GNU debugger. <em>TODO: need to find a good link for intro to gdb.</em></p>

<p>Although it is possible to run gdb directly on the EV3, you will quickly run
out of memory. To get around this, we will do remote debugging.</p>

<p>On your EV3, install <code class="highlighter-rouge">gdbserver</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install gdbserver
</code></pre>
</div>

<p>And in your docker container, install <code class="highlighter-rouge">gdb</code> (or use <code class="highlighter-rouge">arm-linux-gnueabi-gdb</code> in
the cross-compiler directory in <code class="highlighter-rouge">/opt</code>):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install gdb
</code></pre>
</div>

<p>Now, let’s debug our “hello world” program. First, we need to make sure we compile
with debugging symbols (thats the <code class="highlighter-rouge">-g</code> flag). You will need to copy the new
executable to the EV3 too if you haven’t done the <em>mounting a remote file system</em>
thing yet.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>gcc -g -o hello hello.c
</code></pre>
</div>

<p>On the EV3, run <code class="highlighter-rouge">gdbserver</code>. <code class="highlighter-rouge">host</code> is the name or IP address of your host
computer (or VM) and <code class="highlighter-rouge">3333</code> is an arbitrary TCP port.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>gdbserver host:3333 hello
</code></pre>
</div>

<p>Then back in the brickstrap shell run gdb. <code class="highlighter-rouge">target remote</code> tells gdb to connect
to your EV3. Host name resolution seems to have issues in the brickstrap shell,
so you are better off using the IP address of your EV3 (192.168.0.100 in this
example). And of course, the port number needs to match what you used with
gdbserver.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>gdb hello
</code></pre>
</div>

<p>This starts an interactive gdb session. You have to type in the commands
on each line that starts with <code class="highlighter-rouge">(gdb)</code>; the other lines are output and
you should not type them.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>...
Reading symbols from /host-rootfs/home/david/work/brickdm/build/hello...done.
...
(gdb) target remote 192.168.0.100:3333
Remote debugging using 192.168.0.144:1234
...
(gdb) break hello.c:5
Breakpoint 1 at 0x8428: file hello.c, line 5.
(gdb) c
Continuing.

Breakpoint 1, main () at hello.c:5
5               printf("Hello World!\n");
(gdb) c
Continuing.
[Inferior 1 (process 1821) exited normally]
qemu: Unsupported syscall: 26
(gdb) q
</code></pre>
</div>

<p>Since gdb is running in an emulated environment using qemu, you will
occasionally see errors like the unsupported syscall above. Most errors don’t
seem to cause any problems, but it may limit the use of some features of gdb.</p>

<h2 id="example-building-the-brickman-package">Example: Building the brickman Package</h2>

<p>This is how you can use docker to build the <a href="https://github.com/ev3dev/brickman">brickman</a>
package from source.</p>

<p>First, we assume you have already pulled the cross-compiler image as described
above. Then we need to get the source code. Run this wherever you would like to
save the code. For this tutorial, we will assume <code class="highlighter-rouge">C:\Users\myname</code>. We also
create a new empty directory to hold the build output.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>git clone --recursive https://github.com/ev3dev/brickman brickman-src
mkdir brickman-build
</code></pre>
</div>

<p>Now, we are going to create a new image based on that that includes the
build dependencies. If you do this often, you will want to create a <code class="highlighter-rouge">Dockerfile</code>
instead, but for this tutorial, we will do it manually by creating a docker
container and saving the result as a new image. Let’s start a new container…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker run --name brickman -it ev3cc
</code></pre>
</div>

<p>The <code class="highlighter-rouge">--name</code> option will give our container a name, otherwise docker generates
a random name. In the container, install the build dependencies…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get update
sudo apt-get build-dep brickman
exit
</code></pre>
</div>

<p>Then we save the container as a new image. We can also delete the container once
the image is saved.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker commit brickman brickman-ev3
docker rm brickman
</code></pre>
</div>

<p>We now have a new image named <code class="highlighter-rouge">brickman-ev3</code>. Now, lets start a new container
for building…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker run --rm -it -v c:\Users\myname\brickman-src:/src -v c:\Users\myname\brickman-build:/build brickman-ev3
</code></pre>
</div>

<p>This runs a new container with our source code at <code class="highlighter-rouge">/src</code> and our empty directory
at <code class="highlighter-rouge">/build</code>. In the container, we build…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd /build
cmake /src -DCMAKE_TOOLCHAIN_FILE=/opt/gcc-linaro-5.3-2016.02-x86_64_arm-linux-gnueabi/toolchain.cmake
make
mkdir install
DESTDIR=install make install
exit
</code></pre>
</div>

<p>The <code class="highlighter-rouge">CMAKE_TOOLCHAIN_FILE</code> option sets the appropriate options in <code class="highlighter-rouge">cmake</code> to
make use of the cross-compiler to speed things up. We also created a new
<code class="highlighter-rouge">install</code> directory. This will contain the files that need to be copied to
the EV3 to actually run the program.</p>





<h2> Authors </h2>


<div style="float: left; margin-right: 20px;"><!-- Provides unofficial GitHub card function for include.author variable -->




<!-- first function does not work and truncate function returns trailing "..." -->

<!-- this looks weird, but it was the only way I could figure out how to test
     that the first character of include.author is "@" -->

    <div class="user-card user-card-light" data-card-user="dlech"><div class="user-card-name">@dlech</div></div></br>
</div>


    
    </div>
    
    <div id="footer">

        <div class="cclicense">
    
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">
                www.ev3dev.org (with the exception of the projects pages)
            </span>
            is licensed under
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
                <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by-sa/4.0/80x15.png" />
            </a>.
            <br />
            You are free to copy the text and images, but please be courteous and acknowledge the source.
    
        </div>

    <br />
    <div class="container">
        <span>
            Project maintained by <a href="https://github.com/rhempel">Ralph Hempel</a>
            and <a href="https://github.com/dlech">David Lechner</a>, with help from the community
        </span>
    </div>
</div>

</body>
</html>

